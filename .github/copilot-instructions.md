# ScalePlus Copilot Instructions

- **What this is**: A Tampermonkey userscript (`main.user.js`) that orchestrates many self-contained modules in `modules/` via `@require`. No build step; edits ship directly via the raw GitHub URLs referenced in the metadata headers.
- **Module pattern**: Each module is an IIFE exporting `window.ScalePlus<Feature>` and calls `init()` immediately. Most modules gate on `isScalePage()` (presence of `/scale/` in URL) and log `[ScalePlus <Module>]` when skipping or starting.
- **Orchestration**: `main.user.js` waits for all `window.ScalePlus*` namespaces (settings, dark mode, utilities, search pane, favorites, context menu, keyboard, environment labels, advanced criteria, tooltips, checkbox size, settings UI) before final log. Modules are responsible for their own initialization logic and guards.
- **Settings backbone**: `modules/settings.js` defines `SETTINGS` keys and `DEFAULTS` (stored in `localStorage`). `isEnabled(key)` treats any value other than `'false'` as on; some defaults are set dynamically (env labels default on for QA, off for prod; F5/tab duplicator forced false on first run). Always read via `ScalePlusSettings.isEnabled` before acting.
- **Settings UI**: `modules/settings-ui.js` injects a modal (`#scaleplus-settings-modal`) and toggles per setting. On non-Scale pages it exposes a no-op `ScalePlusSettingsUI` to avoid breakage. Add new toggles here when adding settings.
- **Utilities**: `modules/utilities.js` offers `isVisible(el)` (checks display, visibility, pointer-events, disabled classes), whitespace normalization, form-id parsing from `/insights/<id>`, and a simple username cookie lookup. Prefer these helpers before DOM actions.
- **Favorites/default filters**: `modules/favorites.js` stores per-user defaults with keys `${formId}DefaultFilter${username}` using the `UserInformation` cookie. It injects star icons in the favorites dropdown, auto-applies defaults on page load/clear, respects `#pendingFilter=` hashes for cross-tab opens, fetches saved searches via `_webUi`/`_webSession` Scale APIs, and applies advanced/combobox criteria plus kicks `InsightMenuApply` after pending filters. Cleanup routines remove stale localStorage entries and deleted favorites.
- **Keyboard & mouse**: `modules/keyboard.js` handles Enter/F5 overrides, middle-click copy, Ctrl+left or middle-click to open favorites in new tab, and clipboard tooltips. It defers to `ScalePlusSettings` flags (`CUSTOM_ENTER`, `F5_BEHAVIOR`, `MIDDLE_CLICK`, `TAB_DUPLICATOR`). Uses `isVisible` before clicking Apply/Stop.
- **Context menu**: `modules/context-menu.js` adds a right-click menu for grid cells and favorites (copy + set/remove default) gated by `RIGHT_CLICK_MENU`. It highlights cells via `.scaleplus-context-highlight` and reuses `ScalePlusKeyboard.copyInnerText`.
- **Search pane**: `modules/search-pane.js` clicks `a[data-toggle="search"]` if the pane is hidden, controlled by `SHOW_SEARCH_PANE` with a retry/poll pattern.
- **Advanced criteria**: `modules/advanced-criteria.js` shows a count in the accordion header and toggles the `Condition` column plus widths in `#SearchPaneAdvCritAdvCritGrid` using jQuery `igGrid`. Only runs when `ADV_CRITERIA_ENHANCEMENT` is enabled.
- **Dark mode**: `modules/dark-mode.js` toggles `body.scaleplus-dark-mode` (plus instant RF-page guard) and injects scoped styles for grid, scrollbars, loading spinner, and RF forms. Works alongside other modules (context menu, checkbox size) via the body class.
- **Checkbox size**: `modules/checkbox-size.js` extracts native checkbox colors then injects styles and adds `body.scaleplus-bigger-checkboxes` when `BIGGER_CHECKBOXES` is on; targets `span[name="chk"][data-role="checkbox"]` row selectors.
- **Environment labels**: `modules/environment-labels.js` reads `ENV_LABELS` plus custom names (`ENV_QA_NAME`, `ENV_PROD_NAME`) and injects a centered banner, also tinting `#topNavigationBar` border.
- **Tooltips**: `modules/tooltips.js` assigns titles to key nav/actions (Apply, Stop, Clear, favorites, search/detail toggles, menus) and re-applies via a `MutationObserver` when menus re-render.
- **DOM/Selector expectations**: Features rely on Scale IDs/classes such as `#ListPaneDataGrid_scroll`, `#InsightMenuApply`, `#InsightMenuFavoritesDropdown`, `#SearchPaneMenuFavoritesChooseSearch`, and `#topNavigationBar`. Many behaviors use polling (`setTimeout` loops) or `MutationObserver` to wait for dynamic content.
- **Page types**: Several modules skip RF pages using `isScalePage()`; dark mode explicitly supports RF via a separate style block. Ensure new features guard appropriately and add RF handling only when intentionally supported.
- **Adding a module/feature**: Create `modules/<name>.js` IIFE exporting `window.ScalePlusX`. Add `@require` in `main.user.js`, include namespace in `waitForModules`, add setting key + default in `settings.js`, wire toggle in `settings-ui.js`, and document any new selectors/side effects. Respect existing patterns for user-scoped storage and body classes.
- **Distribution/testing**: The userscript runs directly in-page (`@grant none`). Test by loading in Tampermonkey on QA (`scaleqa.byjasco.com`) or prod, watch console for module logs, and verify settings via the "Configure workstation" modal. Raw distribution URL: `https://raw.githubusercontent.com/Blake-goofy/ScalePlus/main/main.user.js`.
